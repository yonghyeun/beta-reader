name: Playwright Tests
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    # GitHub Actionsì— PRì— ëŒ“ê¸€ì„ ë‹¬ ìˆ˜ ìˆëŠ” ê¶Œí•œ ë¶€ì—¬
    permissions:
      contents: read
      pull-requests: write
      issues: write
    defaults:
      run:
        working-directory: ./beta-reader
    steps:
      # ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - uses: actions/checkout@v4

      # Node.js í™˜ê²½ ì„¤ì •
      - uses: actions/setup-node@v4
        with:
          node-version: lts/*
          # npm ìºì‹œ ì„¤ì • ì¶”ê°€
          cache: "npm"
          cache-dependency-path: "./beta-reader/package-lock.json"

      # Playwright ë¸Œë¼ìš°ì €ë¥¼ ìºì‹œì— ì €ì¥
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          # Playwright ë¸Œë¼ìš°ì € ë²„ì „ì„ ìºì‹œ í‚¤ë¡œ ì‚¬ìš©
          key: playwright-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            playwright-

      # í”„ë¡œì íŠ¸ ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        run: npm install

      # Playwright ë¸Œë¼ìš°ì € ì„¤ì¹˜ (ìºì‹œë˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ì‹¤í–‰)
      - name: Install Playwright Browsers
        # ìºì‹œê°€ ì—†ê±°ë‚˜ ì—…ë°ì´íŠ¸ëœ ê²½ìš°ì—ë§Œ ì‹¤í–‰
        run: npx playwright install --with-deps

      # Playwright í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (chromiumë§Œ ì‚¬ìš©í•˜ì—¬ ì†ë„ í–¥ìƒ)
      - name: Run Playwright tests
        run: npx playwright test --project=chromium
        id: playwright-test
        # continue-on-errorë¥¼ ì œê±°í•˜ì—¬ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì‹œ ì›Œí¬í”Œë¡œìš°ë„ ì‹¤íŒ¨í•˜ë„ë¡ í•¨

      # í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë³´ê³ ì„œ ì•„í‹°íŒ©íŠ¸ë¡œ ì—…ë¡œë“œ
      - uses: actions/upload-artifact@v4
        if: ${{ always() }} # í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨í•´ë„ í•­ìƒ ì—…ë¡œë“œ
        with:
          name: playwright-report
          path: beta-reader/playwright-report/
          retention-days: 30

      # ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ ê²°ê³¼ë§Œ í‘œì‹œ
      - name: Create simple test result
        if: ${{ always() && github.event_name == 'pull_request' }}
        run: |
          echo "## ğŸ­ Playwright í…ŒìŠ¤íŠ¸ ê²°ê³¼" > test-summary.md

          if [ "${{ steps.playwright-test.outcome }}" == "success" ]; then
            echo "### âœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µí–ˆìŠµë‹ˆë‹¤! ğŸ‰" >> test-summary.md
            echo "" >> test-summary.md
            echo "í…ŒìŠ¤íŠ¸ê°€ ì •ìƒì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ğŸ‘" >> test-summary.md
          else
            echo "### âŒ ì¼ë¶€ í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤! ğŸ˜¢" >> test-summary.md
            echo "" >> test-summary.md
            echo "ìì„¸í•œ ë‚´ìš©ì€ GitHub Actionsì˜ ì•„í‹°íŒ©íŠ¸ì—ì„œ í™•ì¸í•´ì£¼ì„¸ìš”. ğŸ“" >> test-summary.md
            echo "1. Actions íƒ­ìœ¼ë¡œ ì´ë™" >> test-summary.md
            echo "2. ì´ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì„ íƒ" >> test-summary.md 
            echo "3. Artifacts ì„¹ì…˜ì—ì„œ 'playwright-report' ë‹¤ìš´ë¡œë“œ" >> test-summary.md
          fi

      # PRì— í…ŒìŠ¤íŠ¸ ê²°ê³¼ ëŒ“ê¸€ ì¶”ê°€
      - name: Add test result comment to PR
        if: ${{ always() && github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const fs = require('fs');
            const testSummary = fs.readFileSync('./beta-reader/test-summary.md', 'utf8');

            // PR ë²ˆí˜¸ ì°¾ê¸°
            const pr_number = context.issue.number;

            // ê¸°ì¡´ ëŒ“ê¸€ì´ ìˆëŠ”ì§€ í™•ì¸
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr_number
            });

            const botComment = comments.find(comment => {
              return comment.user.login === 'github-actions[bot]' && 
                     comment.body.includes('Playwright í…ŒìŠ¤íŠ¸ ê²°ê³¼');
            });

            // ê¸°ì¡´ ëŒ“ê¸€ ì—…ë°ì´íŠ¸ ë˜ëŠ” ìƒˆ ëŒ“ê¸€ ì¶”ê°€
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: testSummary
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr_number,
                body: testSummary
              });
            }

      # ì„ì‹œ íŒŒì¼ ì •ë¦¬
      - name: Clean up temporary files
        if: ${{ always() }}
        run: |
          if [ -f "test-summary.md" ]; then
            rm test-summary.md
            echo "Removed temporary test-summary.md file"
          fi

